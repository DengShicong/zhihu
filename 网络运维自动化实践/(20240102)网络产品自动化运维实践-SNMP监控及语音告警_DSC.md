# 网络产品自动化运维实践-SNMP监控及语音告警

 **Author:** [DSC]

 **Link:** [https://zhuanlan.zhihu.com/p/675724838]

## 前言  
### 意义  
网络设备数量成几何级数增加，使得网络管理员对设备的管理变得越来越困难；同时，网络作为一个复杂的分布式系统，其覆盖地域不断扩大，也使得对这些设备进行实时监控和故障排查变得极为困难。网络设备种类多种多样，不同设备厂商提供的管理接口（如命令行接口）各不相同，网络管理变得愈发复杂。CLI命令交互存在局限性，通过Python结合SNMP实现对网络设备的自动化监控，相比于传统的CLI命令交互方式，减少了与设备间的连接与交互，显著提高了运维效率，减少了对人工操作的依赖，使得网络监控不再是繁琐且易出错的任务。这一转变使得网络工程师能够从日常的重复性工作中解放出来，专注于更高层次的网络策略和优化工作。

Python脚本的应用使得监控过程更加灵活和可扩展。它能够轻松适应各种规模和类型的网络环境，屏蔽了设备间的物理差异，SNMP仅提供最基本的功能集，使得管理任务与被管理设备的物理特性、网络类型相互独立，因而可以实现对不同设备的统一管理，管理成本低。实时数据收集和处理能力强化了对网络性能的监控，使得潜在问题可以在影响用户体验之前得到识别和解决。

此外，对于网络发生的异常事件，除了传统的邮件，短信，社交平台（如微信，钉钉）等通知方式，部分场景更是引入了更直观的声、光告警，在紧急情况下迅速引起运维人员注意，以便采取相应的应急措施。



---

### 文章说明  
1. SNMP轮询监控交换机的运行指标（如关键业务端口状态up、down）
2. 监测到网络异常时，实现实时的语音告警通知。
3. 对端口变动信息写入文件保存

代码开源github地址：

[https://github.com/DengShicong/Notification-for-voice](https://github.com/DengShicong/Notification-for-voice)

  


内容描述

此文档内容如下：

1. SNMP，和CLI的方式的差异对比
2. SNMP基本原理
3. SNMP OID获取方式：mib broswer
4. Python 实现SNMP 程序及告警语音播放
5. 效果呈现
6. 技术延伸：SNMP会不会被Telemetry替代

### 开发环境介绍  


| 所需软件 | 版本 | 下载地址 |
| --- | --- | --- |
| Netmiko | 4.2.0 | [https://github.com/ktbyers/netmiko](https://github.com/ktbyers/netmiko)或PyCharm内引入 |
| Python | 3.8.10 | [https://www.python.org/downloads/](https://www.python.org/downloads/) |
| Pycharm | 2023.1.3 | [https://www.jetbrains.com/pycharm/download](https://www.jetbrains.com/pycharm/download) |
| Openpyxl | 3.1.2 | python -m pip install openpyxl 或PyCharm内引入 |
|  |  |  |



---

**SNMP与CLI对比分析**  
SNMP被广泛用于大规模、自动化的网络管理和监控，特别适用于需要跨多个设备和厂商收集统一数据的场景。相比之下，CLI更适用于针对单个设备的详细配置和故障排查。采集网络设备数据时，选择使用简单网络管理协议（SNMP）而非命令行界面（CLI）的原因及二者之间的差异可以从几个关键方面进行对比分析：



| 类别序号 | 项目 | SNMP | CLI |
| --- | --- | --- | --- |
| 1 | 自动化和规模化管理 | 设计用于大规模网络自动化管理。SNMP可以同时监控和管理多个网络设备，无需人工干预。 | 主要用于单个设备的手动配置和管理。CLI在管理大量设备时效率较低，易出错。 |
| 2 | 数据采集和监控 | 专为数据采集和监控设计。它可以定期自动收集设备状态信息，如流量统计、接口状态、系统性能指标等。 | 更适合于具体的配置更改或故障排查。CLI通过手动输入命令来查看设备状态，这种方式在持续监控方面不太实用。 |
| 3 | 标准化和互操作性 | 行业标准，支持跨多种设备和厂商的互操作性。大多数网络设备都支持SNMP。 | 每个厂商的CLI命令可能不同，这增加了学习成本并限制了跨厂商设备的一致性。 |
| 4 | 资源占用和性能 | 对设备资源的占用相对较少，对网络性能的影响也较小。 | 频繁使用CLI可能会对设备性能产生较大影响，特别是在处理复杂命令时。 |
| 5 | 安全性 | 早期版本（如SNMPv1和v2c）的安全性较差，但SNMPv3提供了改进的安全功能，包括加密和认证。 | 通常通过安全协议（如SSH）访问，提供较强的安全性。但是，CLI的手动操作可能会增加人为错误的风险。 |
| 6 | 易用性和灵活性 | 需要一定的学习曲线，特别是对于MIB（管理信息库）和OID（对象标识符）的理解。 | 对于熟悉特定设备的管理员来说更直观，但需要较深的设备特定知识。 |

**SNMP基本原理**

简单网络管理协议SNMP（Simple Network Management Protocol）用于网络设备的管理。SNMP作为广泛应用于TCP/IP网络的网络管理标准协议，提供了统一的接口，从而实现了不同种类和厂商的网络设备之间的统一管理。

SNMP协议分为三个版本：SNMPv1、SNMPv2c和SNMPv3。

* SNMPv1是SNMP协议的最初版本，提供最小限度的网络管理功能。SNMPv1基于团体名认证，安全性较差，且返回报文的错误码也较少。
* SNMPv2c也采用团体名认证。在SNMPv1版本的基础上引入了GetBulk和Inform操作，支持更多的标准错误码信息，支持更多的数据类型（Counter64、Counter32）。
* SNMPv3主要在安全性方面进行了增强，提供了基于USM（User Security Module）的认证加密和基于VACM（View-based Access Control Model）的访问控制。SNMPv3版本支持的操作和SNMPv2c版本支持的操作一样。

SNMP由三部分组成：SNMP内核，管理信息结构SMI和管理信息库MIB

* SNMP内核负责协议结构分析，根据分析结果完成网管动作；
* SMI是一种通用规则，用来命名对象和定义对象类型，以及把对象和对象的值进行编码的规则；
* MIB（全称Management Information Base）在被管理的实体中创建命名对象，也就是一个实例。SMI规定游戏规则，在规则基础上由MIB实现实例化，而SNMP则是实例化的终极执行。

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-d1dec7ddcf35ba79decf22929192a0d1_1440w.jpg)  
* 基本组件



| 管理系统（NMS-Network Management System） | 用于监控和管理网络设备的应用程序或平台。 |
| --- | --- |
| 代理（Agent） | 安装在网络设备上的软件，负责收集和存储关于设备的管理信息，并与NMS通信。 |
| 管理信息库（MIB-Management Information Base） | 是一个包含网络对象的集合，每个对象代表网络设备上的特定信息，如接口状态或系统性能指标。 |

* 管理模型

SNMP的管理体系，在NMS（Network Management System）和Agent两侧进行信令交互。

* NMS作为管理者，向Agent发送SNMP请求报文。
* Agent通过查询设备端的MIB得到所要查询的信息，向NMS发送SNMP响应报文。
* 设备端的模块由于达到模块定义的告警触发条件，通过Agent向NMS发送消息，告知设备侧的出现的情况，这样便于网络管理人员及时的对网络中出现的情况进行处理
* 通信模型  
**请求-响应模式:**  
NMS向代理发送请求（如GET、GETNEXT、SET）来检索信息或修改配置。  
代理响应这些请求，返回所需的数据或执行相应的操作。  
**陷阱（Trap）:**

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-f88135e549fbb8981378294ef49e7280_1440w.jpg)  
  
当特定事件或错误发生时，代理主动向NMS发送陷阱消息，无需NMS的先前请求。  
这种机制使NMS能够及时了解网络中的异常情况。

* 数据格式和操作  
**协议数据单元（PDU）:**   
SNMP规定了5种协议数据单元PDU（也就是SNMP报文），用来在管理进程和代理进程之间的交换。



| PDU类型 | 名称 | 说明 |
| --- | --- | --- |
| 0 | get-request | 从代理进程中提取一个或多个参数值。 |
| 1 | get-next-request | 从代理进程中按照字典序提取下一个参数值。 |
| 2 | get-response | 返回的一个或多个参数值。这个操作是由代理进程发出的 |
| 3 | set-request | 设置代理进程的一个或多个参数值。 |
| 4 | trap | 代理进程主动发出的报文，通知管理进程有某些事情发生 |

  


![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-2eaa96fc5704ae29430c5c7526b687a7_1440w.jpg)  
  
**对象标识符（OID）:**   
每个MIB对象都由唯一的OID标识，  
NMS使用这些OID来指定想要查询或修改的具体对象。

* 安全性对比



| 协议版本 | 用户校验 | 加密 | 鉴权 |
| --- | --- | --- | --- |
| v1 | NO，采用团体字 | NO | NO |
| v2c | NO，采用团体字 | NO | NO |
| v3 | YES，基于用户名的校验 | YES | YES |

备注1，详见：

[https://rfc2cn.com/rfc3416.html](https://rfc2cn.com/rfc3416.html)

RFC 3416: Version 2 of the Protocol Operations for the Simple Network Management Protocol (SNMP)



---

## SNMP OID获取方式  
### 网络设备开启Snmp  
ALE OmniSwitch配置：


![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-afa7d2d3d6953ffade968267290f1086_1440w.jpg)  


交换机开启SNMP示例

  
  
### Mib browser获取  
MIB Browser是一种网络管理工具，它可以用于从SNMP代理设备中读取和显示MIB（Management Information Base，管理信息库）信息。MIB是一种数据库，包含了管理和监控网络设备所需的各种信息，例如设备的状态、配置、性能指标等。

下载地址：[https://www.ireasoning.com/download.shtml](https://www.ireasoning.com/download.shtml)

（MIB Browser Free Personal Edition）

* Mib browser 配置snmp信息

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-324ef23b555b8c0271e37dc54da20df5_1440w.jpg)  
* Mib browser执行snmp walk

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-3cbfe66b4c3113d119aade0434a24bbe_1440w.jpg)  
备注：支持导出XML文件，再通过OFFICE/WPS打开EXCEL表格

  


**SNMP轮询监控端口状态及语音告警**  
使用SNMP协议从给定的IP地址获取特定的OID（对象标识符）信息。它通过调用snmp库中的函数来实现，包括nextCmd函数。

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-97fcf2f81cbbec1c85d0ba6488a9b06b_1440w.jpg)  
设置不同类型设备的oid及对应的IP地址。

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-9a93f9650ad97d169e0e09bc7c3ab13f_1440w.jpg)  
再通过SNMP协议获取设备接口信息，并将结果存储为Excel文件。如果设备不可达，错误信息将被写入单独的Excel文件。如果接口状态有变化，变化的部分将被写入新的Excel文件，并使用颜色标记。最后，将最新的接口信息存储在字典变量previous\_data中，以备后续比较和处理。  
通过TTS（Text To Speech）技术，使用本地语音库播放语音告警

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-3e2ced3b716345ea0276b54ab5a07ce7_1440w.jpg)  
**效果呈现**

通过拔插网线造成端口变动（Up or Down），检测’ifOperStatus’是否改变。端口变动将写入Excel文件内，伴随告警声音提示。

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-1a1705170a76cefa5bb8fa224194d5ff_1440w.jpg)  
文件保存当前目录

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-41d5bbc77cd91511f238ad2fa5372d89_1440w.jpg)  
端口变动文件将以时间日期命名，可保存存档异常。

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-782e6232da931a0f58f637fe7bca8acc_1440w.jpg)  
端口再此变动，恢复正常连接，绿色高亮显示

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-cde8f8b43943793d1202cfc1a81d0471_1440w.jpg)  
同时检测设备IP地址是否可达，是否因为其他设备端口变动导致无法连接。

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-3d1efd8b04a463b5308f824636e8b502_1440w.jpg)  
1. 定期通过SNMP 监控端口状态
2. 端口状态发生变化，写入文件
3. 语音告警

## 技术延伸  
### SNMP存在的问题  
SNMP长期以来一直是网络设备管理的标准协议，提供了一种基于轮询的方式来收集网络设备的状态和性能数据。管理员可以通过SNMP查询（轮询）设备以获取信息，或者配置设备在出现特定事件时通过SNMP陷阱发送通知。

SNMP的优点在于其广泛支持和成熟的标准，但它也存在一些限制，例如效率较低（由于轮询机制）和数据粒度较粗。

例如：

1. 数据不够精准，因为SNMP是基于查询的模式，网管系统通过定期发送SNMP查询信息，存在时间间隔，如果时间间隔太小，会造成系统负载过大，如果时间间隔过大，突发异常信息又无法获取。
2. SNMP通过UDP报文承载信息，例如Trap，如果网络同时监控上千台在线设备，不同时间段的SNMP Trap信息泛洪，UDP报文堵塞，丢弃，重传，导致Trap信息延迟，
3. 可操作性，虽然SNMP是标准协议，但各个厂家都有自己的私有MIB库，不通的定义，导致实际使用时非常不便利。而且oid的设计，可读性非常差，

例如1.3.6.1.2.1.2.1.8 ，这个SNMP的OID， 他的意思是IF-MIB的接口状态，ifOperStatus，本文所用到的，但只有专业人员才知道。

## Telemetry的技术原理  
Telemetry是一项远程的从物理设备或虚拟设备上高速采集数据的技术。设备通过推模式（Push Mode）周期性的主动向采集器上送设备的接口流量统计、CPU或内存数据 等信息，相对传统拉模式（Pull Mode）的一问一答式交互，提供了更实时更高速的数据采集功能。

![]((20240102)网络产品自动化运维实践-SNMP监控及语音告警_DSC/v2-f89003c6bae7d112b40339e5d99cddc5_1440w.png)  


| 序号 | 条目 | 主动上报 Push | 被动查询 Pull |
| --- | --- | --- | --- |
| 1 | 设备初始检测 | 网络设备启动后马上上报注册，让监控系统即可发现自己，保证了监控的即时性和不间断性。 | 需要监控系统定期扫描地址段来发现新的设备，扫描速度取决于地址段的大小和扫描间隔。 |
| 2 | 扩展性 | 上报状态数据这一环节交给了每一台网络设备，而监控系统仅仅是监听发过来的更新数据并存储到系统内。对于网络设备而言，只要有数据就马上发送给监控端，而且无论网络设备端还是监控端，都不需要维持会话关系， 一次性传输。 | 监控系统的负载和查询客户端数成正比，同时监控系统还需要为每一个查询持有会话信息，这样才能匹配返回的查询结果。被查询的网络设备，需要临时中断其他任务来处理查询命令。 |
| 3 | 运维复杂度 | 简单配置网络设备即可实现主动上报数据的功能相关防火墙需要开启策略运行网络设备传输数据到监控系统，这个与传统查询方式相反。 | 监控平台需要配置大量的设备列表，以及接入这些设备所需要的密码或者community,以及你需要收集的数据类型等。防火墙需要放开双向通信，查询和trap |
| 4 | 数据精确度和延迟 | 高频率传输，单向传输，开销低，实时性高。 | 长间隔时间，保持回话，双向传输，开销高，实时性低。 |
| 5 | 灵活性 | 相对的灵活性，只能导出设备预定义的参数。 | 灵活性高，可以导出任何MIB定义好的数据参数。 |

Telemetry，相比之下，是一种更现代的方法，通常用于实时、高频率地收集网络性能数据。Telemetry技术可以主动推送数据到收集系统，而不是等待轮询请求。这使得Telemetry可以提供更精细、更实时的网络性能视图，尤其适用于大规模和高速网络环境。

### Telemetry替代SNMP？  
虽然Telemetry相对其他的网管模式有一定的优点，如下表



| 对比项 | Telemetry | SNMP Get | SNMP Trap | CLI | SYSLOG |
| --- | --- | --- | --- | --- | --- |
| 工作模式 | 推模式 | 拉模式 | 推模式 | 拉模式 | 推模式 |
| 精度 | 亚秒级 | 分钟级 | 秒级 | 分钟级 | 秒级 |
| 是否结构化 | YANG模型定义结构 | MIB定义结构 | MIB定义结构 | 非结构化 | 非结构 |

但现实情况下，目前还不能马上断言Telemetry会很快替代SNMP

* 网络设备和基础设施的现代化程度：新的网络设备和平台更可能支持Telemetry，而老旧设备可能仍依赖SNMP。
* 特定用途和需求：对于一些基本的监控和管理任务，SNMP可能仍然足够有效。但对于需要高分辨率和实时数据的场景，Telemetry可能是更好的选择。
* 过渡和兼容性：在很多网络环境中，SNMP和Telemetry可能会并存一段时间。对于许多组织来说，逐步过渡到Telemetry而不是突然完全替换SNMP可能是一个更现实的选择。

Telemetry提供了一些显著的优势，特别是在高性能和大规模网络环境中，但SNMP仍然在许多网络中发挥作用，短期内可能不会被完全替代。不过，随着技术的发展和新需求的出现，我们可以预见Telemetry在网络管理领域的地位会越来越重要。

  


**本人涉及资料来源于日常工作及互联网搜索，已做脱敏处理，如果仍存有涉及侵权内容，请告知。将做删除修改。如有错误，欢迎大家指正。**

