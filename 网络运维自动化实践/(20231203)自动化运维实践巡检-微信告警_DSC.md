# 自动化运维实践巡检-微信告警

 **Author:** [DSC]

 **Link:** [https://zhuanlan.zhihu.com/p/670132231]

## 自动化运维实践巡检微信告警  
完整脚本地址在：

[https://github.com/DengShicong/Notification-for-wechat](https://github.com/DengShicong/Notification-for-wechat)该脚本是集成版本（大杂烩）具有以下功能：

1. 自动化巡检通过CLI交互获取回显信息。
2. 将回显信息通过WxPusher发送到公众号，点击查看详细内容。
3. 将回显信息制作简易巡检报告，设备health信息与温度信息以高亮颜色设置（红/绿），表示处于正常与异常
4. sftp下载交换机配置文件vcboot.cfg/boot.cfg，对应ALE AOS 6.0/7.0/8.0。
5. 将配置文件与巡检报告打包发送邮件到运维团队，支持多人接收。

**本文仅针对微信告警介绍。**

### 意义  
使用Python对ALE网络设备进行自动化运维巡检，并通过微信公众号实现告警通知和内容推送，与其他通知方式相比，具有独特的优势和深远的意义。与传统的电子邮件或短信通知相比，微信公众号的即时性和互动性更强。例如，在使用电子邮件时，用户可能不会即时检查邮件，而短信通知则可能因为成本问题而被限制使用。微信公众号作为一种广泛使用的通讯工具，使得告警信息能够以更加直接和快速的方式送达目标用户。用户几乎实时地查看微信消息，因此，当系统发生异常时，相关人员能够在第一时间得到通知，从而实现快速响应。微信公众号提供的丰富互动功能，如消息模板、快速回复等，使得运维团队不仅能发送通知，还能收集用户反馈，甚至实现一定程度的自动化交互，用户可以通过点击消息中的链接或按钮来获取更多信息。因此，与其他通知方式相比，通过微信公众号进行自动化运维巡检的通知不仅提高了告警的及时性和可达性，而且通过增强用户互动和参与，提升了整个运维流程的效率和用户满意度。这种方法不仅使运维团队能够更有效地管理系统状态，也为用户提供了更为便捷、直观的服务体验。

  


### 常见告警通知分析  
### 邮件通知：  
优势：

1. 普遍接受度高：几乎所有人都使用电子邮件，易于接受和处理。
2. 信息内容丰富：可以发送较长的文本，附带链接、附件等。
3. 历史记录管理：邮件易于存档和搜索，便于追溯和管理历史告警。
4. 定制化强：可以通过邮件模板自定义告警内容和格式。

劣势：

1. 实时性较差：邮件可能不会被即时查看，特别是在非工作时间。
2. 依赖网络状况：网络问题可能导致邮件延迟或发送失败。

### 微信公众号通知：  
优势：

1. 实时性强：大多数用户常开微信，可快速获得通知。
2. 互动性强：用户可以通过微信公众号直接进行反馈或交互。
3. 广泛覆盖：在中国微信使用非常普遍，覆盖面广。

劣势：

1. 局限性：主要局限于中国用户，国际用户可能不常用。
2. 内容限制：消息长度和格式有限制，不能发送过长的文本或复杂内容。

### 短信通知：  
优势：

1. 高可达性：即使在没有网络的情况下，也可以接收短信。
2. 简洁直接：短信内容简短，能快速传达核心信息。

劣势：

1. 成本较高：发送短信通常需要支付费用。
2. 信息量有限：短信长度限制，不能提供过多详细信息。
3. 用户干扰：频繁的短信可能被用户视为干扰。

### 钉钉、企业微信、飞书群通知：  
优势：

1. 针对企业用户：专为企业通信设计，适合内部员工通知。
2. 功能丰富：支持丰富的消息类型，如文本、图片、文件等。
3. 集成便捷：可与企业内部系统轻松集成，支持自动化流程。

劣势：

1. 使用范围有限：主要用于企业内部，对于外部用户覆盖面有限。
2. 依赖应用安装：需要用户安装相应的应用程序。
3. 可能导致信息过载：在群组中的通知可能因为信息量大而被忽略。

### 微信告警通知实现  
### 推送效果  
Server Chan：微信通知效果，支持多种推送，包括但不限于企业微信，钉钉飞书等。

![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-4e016687060d4620dac50997b7a412aa_1440w.jpg)  
WxPusher：微信公众号推送，步骤简单，便捷

![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-398a681b393844f0edc164daf4598aa5_1440w.jpg)  
### WxPusher整体架构  
![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-de74b83281f88b7de51369d0c259e34b_1440w.jpg)  


| 参数 | 描述 |
| --- | --- |
| APP\_TOKEN | 应用的身份标志，唯一性，可以给对应的应用的用户发送消息 |
| UID | 微信用户标志，在单独给某个用户发送消息时，来说明要发给哪个用户。 |
| 主题(Topic) | 主题(Topic)是应用下面，一类消息的集合，不能针对用户定制消息 |

### Python与WxPusherr对接技术实现  


| 步骤 | 描述 |
| --- | --- |
| 1 | 引入必要的库：通常需要使用 requests 库来发送 HTTP 请求。 |
| 2 | 获取 API 密钥：在 WxPusher 的网站上注册并创建应用以获取 API 密钥。 |
| 3 | 构造请求数据：根据 WxPusher 文档，构造正确的数据格式，通常是 JSON 格式，包括你的 API 密钥、消息内容、目标用户的 ID 等。 |
| 4 | 发送请求：使用 requests 库向 WxPusher 的 API 端点发送 POST 请求，附带上述构造的数据。 |
| 5 | 处理响应：处理 WxPusher 返回的响应，确认消息是否成功发送。 |

### 在WxPusher管理地址获取Token与uids，地址如下：  
[WxPusher微信消息推送服务](https://wxpusher.zjiecode.com/admin/login)### 创建与注册应用：作为公众号提供关注与推送消息内容  
![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-bc8f123e6fcc5a1d54359787872dd59e_1440w.jpg)  
### 获取APP\_TOKEN  
![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-d9c8583659526519ec7833ddc3f06240_1440w.jpg)  
### 微信用户关注公众号后管理后台可查看用户UID，须在脚本内添加UID才能接收推送信息，相当于人工验证，安全授权后才能获取通知。  
![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-c5e6adebb79eb03b3620d85fcfe80cd8_1440w.jpg)  
### 将APP\_TOKEN与UID在脚本内对应填写  
![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-00591b5b6417bd684822b718cf5ec0d4_1440w.jpg)  
### 设置函数用于向微信推送器发送消息，并定义参数  
![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-b2ace326fc7b56a94c9221ca3487ff85_1440w.jpg)  
### 将收集的设备信息作为内容进行推送  
![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-5a7cf6cc68293d44b987718fe55406e2_1440w.jpg)  
## 总结  
Python自动化巡检对接微信公众号提供方便即时的告警推送，提高了通知的效率和便捷性。

1. 便捷性：微信与移动端设备与人高度绑定，几乎随身携带，使用微信无论是在移动端还是PC端都便捷地接收告警推送，
2. 即时性：通过微信推送消息，确保了运维人员能够在第一时间接收到告警，延迟相较其他方式较低，便于对紧急情况做出快速响应。
3. 简化告警流程：通过自动化脚本，减少了手动检查系统状态的需要，使告警流程更加高效和直接。
4. 灵活性和可定制性：Python 脚本提供了灵活的定制选项，允许根据不同的运维需求调整告警的内容和格式。
5. 适应性强：不仅仅使用WxPusher还有微信公众平台，server chan等多种微信推送平台。
6. 成本效益：与传统的短信或电话告警相比，微信公众号提供了一种成本较低的替代方案，同时保持了高效的通知能力。

  


## 巡检报告效果延伸  
### 自动生成Word报告文件  
自动化收集回显信息后制作word巡检报告，对健康度参数判断并有高亮显示，再进行邮件自动发送巡检报告

![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-26bc5bf198ce2d0875f902aca1081352_1440w.jpg)  
### 输出HTML文件网页展示  
将自动化运维收集的回显信息制作HTML文件，只需有浏览器便可查看网络设备信息 

![]((20231203)自动化运维实践巡检-微信告警_DSC/v2-8cc4f6ac52b119bed542bffc344a6fc8_1440w.jpg)  


防火墙License到期时间收集效果

  
  
  


**本人涉及资料来源于日常工作及互联网搜索，已做脱敏处理，如果仍存有涉及侵权内容，请告知。将做删除修改。如有错误，欢迎大家指正。**

